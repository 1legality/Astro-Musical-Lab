---
// Reusable 16‑step sequencer (visual + simple playback)
// Tailwind for layout; integrates with SynthEngine for beep playback
const {
  title = undefined,
  steps = [],              // primary active steps (1-based indices)
  secondarySteps = [],     // optional secondary layer (1-based indices)
  note = 60,               // primary MIDI note
  secondaryNote = 67,      // secondary MIDI note
  bpm = 120,               // tempo
  duration = 0.06          // seconds per triggered note
} = Astro.props;

// Generate a stable unique id per component instance
const uid = `seq16_${Math.random().toString(36).slice(2)}`;

// Normalize to 0-based for rendering logic in script
const primary0 = Array.from(new Set(steps)).map(n => Number(n) - 1).filter(n => n>=0 && n<16);
const secondary0 = Array.from(new Set(secondarySteps)).map(n => Number(n) - 1).filter(n => n>=0 && n<16);
---

<div id={uid} class="w-full bg-white/70 rounded-lg border border-gray-200 p-4 shadow-sm">
  {title && <h3 class="text-sm font-semibold text-gray-800 mb-3">{title}</h3>}

  <div class="">
    <div class="relative mb-3">
      <div class="grid grid-cols-16 gap-1">
        {Array.from({ length: 16 }).map((_, i) => {
          const isA = primary0.includes(i);
          const isB = secondary0.includes(i);
          const both = isA && isB;
          return (
            <div class={`relative flex items-center justify-center w-full aspect-square select-none rounded-sm border ${both ? 'bg-purple-500/80 border-purple-600 text-white' : isA ? 'bg-blue-500/80 border-blue-600 text-white' : isB ? 'bg-emerald-500/80 border-emerald-600 text-white' : 'bg-gray-100 border-gray-200 text-gray-500'}`}>
              <span class="text-[10px] leading-none">{i + 1}</span>
            </div>
          );
        })}
      </div>

      {/* visual group separators at 25%, 50%, 75% without affecting cell widths */}
      <div class="pointer-events-none absolute inset-0">
        <div class="absolute top-0 bottom-0 w-px bg-gray-300/70" style="left: 25%"></div>
        <div class="absolute top-0 bottom-0 w-px bg-gray-300/70" style="left: 50%"></div>
        <div class="absolute top-0 bottom-0 w-px bg-gray-300/70" style="left: 75%"></div>
      </div>
    </div>
  </div>

  <div class="flex items-center gap-2">
    <button data-action="play" class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-1 px-3 rounded">Play</button>
    <button data-action="loop" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm py-1 px-3 rounded">Loop</button>
    <button data-action="stop" class="bg-red-600 hover:bg-red-700 text-white text-sm py-1 px-3 rounded">Stop</button>
    <div class="ml-3 text-xs text-gray-600">{bpm} BPM • 16th = {(60 / bpm / 4).toFixed(3)}s</div>
  </div>

  <script type="application/json" id={`${uid}-data`}>
    {JSON.stringify({ primary0, secondary0, note, secondaryNote, bpm, duration })}
  </script>

</div>

<style>
  /* 16 equal columns utility since Tailwind doesn't include grid-cols-16 by default */
  .grid-cols-16 { grid-template-columns: repeat(16, minmax(0, 1fr)); }
</style>

{/* Inline replace of container id marker in the client script */}
<!-- no inline patching needed; script uses parentElement as container -->

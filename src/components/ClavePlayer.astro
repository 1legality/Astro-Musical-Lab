---
// src/components/ClavePlayer.astro
---

<div class="midi-player">
  <p>Click to play Son Clave (3-2)</p>
  <button id="play-clave">Play</button>
  <button id="loop-clave">Loop</button>
  <button id="stop-clave">Stop</button>
</div>

<script>
  import { SynthEngine } from '../lib/SynthEngine';

  const synth = new SynthEngine();
  let loopInterval: number | undefined;

  const clavePattern = [
    { note: 60, duration: 0.125, wait: 0.25 },    // 1
    { note: 60, duration: 0.125, wait: 0.375 },   // 1a
    { note: 60, duration: 0.125, wait: 0.5 },     // 2&
    { note: 60, duration: 0.125, wait: 0.75 },    // 3&
    { note: 60, duration: 0.125, wait: 1.25 },    // 4
  ];

  async function playClave() {
    await synth.ensureContextResumed();
    console.log('Playing Clave!');

    clavePattern.forEach(noteEvent => {
      window.setTimeout(() => {
        synth.playChord([noteEvent.note], noteEvent.duration);
      }, noteEvent.wait * 1000); // Convert to ms
    });
  }

  function startLoop() {
    if (loopInterval) return;
    playClave(); // Play immediately
    loopInterval = window.setInterval(playClave, 2000);
  }

  function stopLoop() {
    if (loopInterval) {
      window.clearInterval(loopInterval);
      loopInterval = undefined;
    }
  }

  document.getElementById('play-clave')?.addEventListener('click', playClave);
  document.getElementById('loop-clave')?.addEventListener('click', startLoop);
  document.getElementById('stop-clave')?.addEventListener('click', stopLoop);
</script>

<style>
  .midi-player {
    border: 1px solid #ccc;
    background: #f9f9f9;
    padding: 1rem;
    border-radius: 8px;
  }
</style>
import{j as d}from"./jsx-runtime.ClP7wGfN.js";import{r as C}from"./index.DK-fsZOb.js";class I{audioContext=null;mainGainNode=null;reverbNode=null;pannerNode=null;reverbSendGain=null;activeNotes=new Set;initialVolume;constructor(i=.5){this.initialVolume=Math.max(0,Math.min(1,i))}initAudioContext(){if(this.audioContext)return!0;if(typeof window>"u")return!1;try{return this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.mainGainNode=this.audioContext.createGain(),this.pannerNode=this.audioContext.createStereoPanner(),this.reverbNode=this.audioContext.createConvolver(),this.reverbSendGain=this.audioContext.createGain(),this.mainGainNode.connect(this.pannerNode),this.pannerNode.connect(this.audioContext.destination),this.mainGainNode.connect(this.reverbSendGain),this.reverbSendGain.connect(this.reverbNode),this.reverbNode.connect(this.audioContext.destination),this.setReverb(.4),this.createReverbImpulseResponse(),this.mainGainNode.gain.setValueAtTime(this.initialVolume,this.audioContext.currentTime),console.log("AudioContext initialized successfully."),!0}catch(i){return console.error("Web Audio API is not supported or could not be initialized.",i),!1}}createReverbImpulseResponse(){if(!this.audioContext||!this.reverbNode)return!1;const i=this.audioContext.sampleRate,t=3,e=4.5,c=this.audioContext.createBuffer(2,t*i,i);for(let n=0;n<2;n++){const s=c.getChannelData(n);for(let o=0;o<c.length;o++)s[o]=(Math.random()*2-1)*Math.pow(1-o/c.length,e)}return this.reverbNode.buffer=c,!0}setReverb(i){if(!this.reverbSendGain||!this.pannerNode)return;const t=Math.max(0,Math.min(1,i));this.reverbSendGain.gain.value=t,this.pannerNode}setPan(i){this.pannerNode&&(this.pannerNode.pan.value=Math.max(-1,Math.min(1,i)))}async ensureContextResumed(){if(this.initAudioContext()&&this.audioContext.state==="suspended"){console.log("Resuming AudioContext...");try{await this.audioContext.resume(),console.log("AudioContext resumed successfully.")}catch(i){console.error("Error resuming AudioContext:",i)}}}midiNoteToFrequency(i){return 440*Math.pow(2,(i-69)/12)}playChord(i,t=.05){if(!this.initAudioContext()||!this.audioContext||!this.mainGainNode)return;const e=this.audioContext.currentTime;i.forEach(c=>{const n=this.midiNoteToFrequency(c-24),s=this.audioContext.createOscillator();s.type="triangle",s.frequency.setValueAtTime(n*8,e),s.frequency.exponentialRampToValueAtTime(n,e+.25);const o=this.audioContext.createOscillator();o.type="triangle",o.frequency.setValueAtTime(n*4.53,e),o.frequency.exponentialRampToValueAtTime(n*.5,e+.3);const h=this.audioContext.createBufferSource(),x=this.audioContext.sampleRate*.05,g=this.audioContext.createBuffer(1,x,this.audioContext.sampleRate),f=g.getChannelData(0);for(let p=0;p<x;p++)f[p]=Math.random()*2-1;h.buffer=g;const r=this.audioContext.createBiquadFilter();r.type="lowpass",r.Q.value=2,r.frequency.setValueAtTime(6e3,e),r.frequency.exponentialRampToValueAtTime(80,e+.04);const a=this.audioContext.createGain();a.gain.setValueAtTime(.8,e),a.gain.exponentialRampToValueAtTime(.001,e+t*1.5),s.connect(a),o.connect(a),h.connect(r),r.connect(a),a.connect(this.mainGainNode);const y=e+t,m={midiNote:c,velocity:1,duration:t,oscillators:[s,o],noiseSource:h,filter:r,noteGain:a,stopTime:y};this.activeNotes.add(m);const T=()=>{if(this.activeNotes.has(m)){try{s.disconnect(),o.disconnect(),h.disconnect(),r.disconnect(),a.disconnect()}catch{}this.activeNotes.delete(m)}};s.onended=T,s.start(e),o.start(e),h.start(e),s.stop(y),o.stop(y+.1),h.stop(e+.05)})}startChord(i){if(!this.initAudioContext()||!this.audioContext||!this.mainGainNode)return[];const t=this.audioContext.currentTime,e=[];return i.forEach(c=>{const n=this.midiNoteToFrequency(c-24),s=this.audioContext.createOscillator();s.type="triangle",s.frequency.setValueAtTime(n*8,t),s.frequency.exponentialRampToValueAtTime(n,t+.25);const o=this.audioContext.createOscillator();o.type="triangle",o.frequency.setValueAtTime(n*4.53,t),o.frequency.exponentialRampToValueAtTime(n*.5,t+.3);const h=this.audioContext.createBufferSource(),x=this.audioContext.sampleRate*.05,g=this.audioContext.createBuffer(1,x,this.audioContext.sampleRate),f=g.getChannelData(0);for(let m=0;m<x;m++)f[m]=Math.random()*2-1;h.buffer=g;const r=this.audioContext.createBiquadFilter();r.type="lowpass",r.Q.value=2,r.frequency.setValueAtTime(6e3,t),r.frequency.exponentialRampToValueAtTime(80,t+.04);const a=this.audioContext.createGain();a.gain.setValueAtTime(.8,t),s.connect(a),o.connect(a),h.connect(r),r.connect(a),a.connect(this.mainGainNode);const y={midiNote:c,velocity:1,duration:1/0,oscillators:[s,o],noiseSource:h,filter:r,noteGain:a,stopTime:1/0};this.activeNotes.add(y),e.push(y),s.start(t),o.start(t),h.start(t)}),e}stopNotes(i){if(!this.initAudioContext()||!this.audioContext||this.activeNotes.size===0)return;const t=this.audioContext.currentTime,e=.1;(i||Array.from(this.activeNotes)).forEach(n=>{n.noteGain.gain.cancelScheduledValues(t),n.noteGain.gain.setValueAtTime(n.noteGain.gain.value,t),n.noteGain.gain.exponentialRampToValueAtTime(1e-4,t+e);const s=t+e+.01;n.oscillators.forEach(o=>{try{o.stop(s),n.noiseSource?.stop(t)}catch{}}),setTimeout(()=>{if(this.activeNotes.has(n)){try{n.oscillators.forEach(o=>o.disconnect()),n.noiseSource?.disconnect(),n.filter?.disconnect(),n.noteGain.disconnect()}catch{}this.activeNotes.delete(n)}},e*1e3+50)})}stopAll(){if(!this.initAudioContext()||!this.audioContext||this.activeNotes.size===0)return;const i=this.audioContext.currentTime,t=.1;this.activeNotes.forEach(e=>{if(i<e.stopTime){e.noteGain.gain.cancelScheduledValues(i),e.noteGain.gain.setValueAtTime(e.noteGain.gain.value,i),e.noteGain.gain.exponentialRampToValueAtTime(1e-4,i+t);const c=i+t+.01;e.oscillators.forEach(n=>{try{n.stop(c),e.noiseSource?.stop(i)}catch{}})}}),setTimeout(()=>{this.activeNotes.forEach(e=>{try{e.oscillators.forEach(c=>c.disconnect()),e.noiseSource?.disconnect(),e.filter?.disconnect(),e.noteGain.disconnect()}catch{}}),this.activeNotes.clear()},t*1e3+50)}setVolume(i){if(!this.initAudioContext()||!this.mainGainNode)return;const t=Math.max(0,Math.min(1,i));this.mainGainNode.gain.setValueAtTime(t,this.audioContext.currentTime)}getVolume(){return!this.initAudioContext()||!this.mainGainNode?this.initialVolume:this.mainGainNode.gain.value}}const F=({title:A,steps:i=[],secondarySteps:t=[],note:e=60,secondaryNote:c=67,bpm:n=120,duration:s=.06})=>{const[o,h]=C.useState(()=>{const u=Array(16).fill(!1);return i.forEach(l=>{l>0&&l<=16&&(u[l-1]=!0)}),u}),[x,g]=C.useState(()=>{const u=Array(16).fill(!1);return t.forEach(l=>{l>0&&l<=16&&(u[l-1]=!0)}),u}),[f,r]=C.useState(!1),[a,y]=C.useState(!0),[m,T]=C.useState(0),p=C.useRef(null),v=C.useRef(null);C.useEffect(()=>{typeof window<"u"&&(p.current=new I)},[]);const S=60/n/4*1e3;C.useEffect(()=>(f?v.current=setInterval(()=>{T(u=>{const l=u+1;return l>=16?a?0:(r(!1),15):l})},S):v.current&&clearInterval(v.current),()=>{v.current&&clearInterval(v.current)}),[f,a,S]),C.useEffect(()=>{if(f){const u=[];o[m]&&u.push(e),x[m]&&u.push(c),u.length>0&&p.current&&p.current.playChord(u,s)}},[m,f,o,x,e,c,s]);const w=async()=>{p.current&&await p.current.ensureContextResumed(),f||T(-1),r(!f)},V=()=>{r(!1),T(0),p.current&&p.current.stopAll()},R=(u,l=!1)=>{if(l){const b=[...x];b[u]=!b[u],g(b)}else{const b=[...o];b[u]=!b[u],h(b)}};return d.jsxs("div",{className:"card bg-base-200/70 border border-base-300 shadow-xl",children:[d.jsxs("div",{className:"card-body space-y-4",children:[A&&d.jsx("h3",{className:"card-title text-sm font-semibold uppercase tracking-wide",children:A}),d.jsxs("div",{className:"relative",children:[d.jsx("div",{className:"grid grid-cols-16 gap-1",children:Array.from({length:16}).map((u,l)=>{const b=o[l],G=x[l],j=b&&G,q=f&&m===l,E="btn btn-square btn-xs font-semibold select-none transition-colors duration-150";let N="btn-outline btn-neutral text-base-content/70 border-base-300 bg-base-100/40 hover:text-base-content";j?N="btn-accent text-accent-content":b?N="btn-primary text-primary-content":G&&(N="btn-warning text-warning-content");const M=q?"ring ring-offset-2 ring-offset-base-200 ring-secondary":"";return d.jsx("button",{type:"button",className:`${E} ${N} ${M}`,onClick:()=>R(l),children:d.jsx("span",{className:"text-[10px] leading-none",children:l+1})},l)})}),d.jsxs("div",{className:"pointer-events-none absolute inset-0 opacity-40",children:[d.jsx("div",{className:"absolute top-0 bottom-0 w-px bg-base-300",style:{left:"25%"}}),d.jsx("div",{className:"absolute top-0 bottom-0 w-px bg-base-300",style:{left:"50%"}}),d.jsx("div",{className:"absolute top-0 bottom-0 w-px bg-base-300",style:{left:"75%"}})]})]}),d.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[d.jsx("button",{onClick:w,className:"btn btn-primary btn-sm",children:f?"Pause":"Play"}),d.jsx("button",{onClick:V,className:"btn btn-error btn-sm",children:"Stop"}),d.jsx("button",{onClick:()=>y(!a),className:`btn btn-sm ${a?"btn-secondary":"btn-outline btn-secondary"}`,children:a?"Loop On":"Loop Off"}),d.jsxs("div",{className:"badge badge-outline badge-lg font-mono gap-1",children:[n," BPM ",d.jsx("span",{children:"â€¢"})," 16th = ",(60/n/4).toFixed(3),"s"]})]})]}),d.jsx("style",{children:".grid-cols-16 { grid-template-columns: repeat(16, minmax(0, 1fr)); }"})]})};export{F as default};
